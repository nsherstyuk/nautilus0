# Phase 4: Risk Management Parameter Optimization
# ================================================
# 
# This configuration optimizes risk management parameters (stop loss, take profit, 
# and trailing stops) while keeping Phase 3 best MA parameters fixed.
# 
# Total combinations: 500 (5×5×4×5)
# Parameters being optimized: 4 risk management parameters
# Fixed parameters: Phase 3 best MA parameters + all filter parameters
# Expected runtime: 8-10 hours with 8 workers
# 
# Prerequisites: Phase 3 must complete successfully first
# Phase 3 Best Results (from rank 1):
#   - fast_period: 42
#   - slow_period: 270  
#   - crossover_threshold_pips: 0.35
#   - sharpe_ratio: 0.272
#   - total_pnl: $5,644.69
#   - win_rate: 48.3%
#   - trade_count: 60
#   - Source: optimization/results/phase3_fine_grid_results_top_10.json
#
# Usage:
#   python optimization/grid_search.py \
#     --config optimization/configs/phase4_risk_management.yaml \
#     --objective sharpe_ratio \
#     --workers 8 \
#     --output optimization/results/phase4_risk_management_results.csv \
#     --no-resume \
#     --verbose
#
# Expected runtime: 8-10 hours with 8 workers (500 backtests × ~60s each ÷ 8 workers)
# Phase context: Third optimization phase, results will be used for Phase 5 filter optimization
#
# Success criteria:
#   - Best result improves on Phase 3 Sharpe ratio of 0.272 (target: 0.28-0.35 range)
#   - Top 10 results show clear risk/reward ratio patterns
#   - Profit factor improves over baseline
#   - Max drawdown remains acceptable (< $2,000)

# Optimization Settings
# ====================
optimization:
  objective: sharpe_ratio  # Maximize risk-adjusted returns
  workers: 8               # Parallel execution
  checkpoint_interval: 10   # Save progress every 10 backtests
  timeout_seconds: 300     # 5 minutes per backtest
  output_file: optimization/results/phase4_risk_management_results.csv
  checkpoint_file: optimization/checkpoints/phase4_risk_management_checkpoint.csv

# Parameters Being Optimized
# ==========================
# Risk Management Parameters - 4 parameters, 500 total combinations
parameters:
  # Stop Loss Pips: Test range from tight (15 pips) to loose (35 pips) stops
  # Tighter stops reduce max loss but may increase false exits
  # Looser stops allow more breathing room but increase risk per trade
  stop_loss_pips:
    values:
      - 5
      - 10
      - 15  # Tight stop - quick exits, higher trade count
      - 20  # Moderate tight stop
      - 25  # Baseline stop (current best from Phase 3)
      - 30  # Moderate loose stop
      - 35  # Loose stop - more breathing room, higher risk per trade

  # Take Profit Pips: Test range from conservative (30 pips) to aggressive (75 pips)
  # Smaller targets increase win rate but reduce profit per trade
  # Larger targets decrease win rate but increase profit per winning trade
  take_profit_pips:
    values:
      - 15  # Very tight target
      - 20  # Very conservative target
      - 30  # Conservative target (2:1 RR with 15 pip SL)
      - 40  # Moderate conservative target
      - 50  # Baseline target (current best from Phase 3)
      - 60  # Moderate aggressive target
      - 75  # Aggressive target (2.5:1 RR with 30 pip SL)

  # Trailing Stop Activation: Test when trailing stop activates (distance in profit before trailing begins)
  # Earlier activation protects profits sooner but may exit prematurely
  # Later activation allows more profit potential but risks giving back gains
  trailing_stop_activation_pips:
    values:
      - 5   # Immediate activation - very tight trailing
      - 10  # Immediate activation
      - 15  # Very early activation
      - 22  # Early activation - protect profits quickly
      - 25  # Moderate early activation
      - 28  # Baseline activation (current best from Phase 3)
      - 32  # Late activation - allow more profit potential

  # Trailing Stop Distance: Test how closely trailing stop follows price
  # Tighter trailing locks in profits quickly but may exit on minor retracements
  # Looser trailing allows more retracement but risks larger profit giveback
  trailing_stop_distance_pips:
    values:
      - 4
      - 8   # Very tight trailing - lock in profits very quickly
      - 10  # Tight trailing - lock in profits quickly
      - 12  # Moderate tight trailing
      - 14  # Baseline trailing (current best from Phase 3)
      - 16  # Moderate loose trailing
      - 18  # Loose trailing - allow more retracement

# Fixed Parameters (Phase 3 Best Values)
# ======================================
# All parameters below are fixed at Phase 3 best values and will not be optimized
fixed:
  # MA Parameters (Fixed at Phase 3 Best - DO NOT CHANGE)
  # These are the optimal MA parameters from Phase 3 and must not be changed
  fast_period: 42                    # Phase 3 rank 1 value
  slow_period: 270                   # Phase 3 rank 1 value  
  crossover_threshold_pips: 0.35    # Phase 3 rank 1 value

  # Crossover Filter Parameters (Fixed)
  pre_crossover_separation_pips: 0.0    # Disabled
  pre_crossover_lookback_bars: 1        # Default

  # DMI Filter Parameters (Fixed at Phase 3 Best - Will be optimized in Phase 5)
  dmi_enabled: true
  dmi_period: 14
  dmi_bar_spec: "2-MINUTE-MID-EXTERNAL"

  # Stochastic Filter Parameters (Fixed at Phase 3 Best - Will be optimized in Phase 5)
  stoch_enabled: true
  stoch_period_k: 14
  stoch_period_d: 3
  stoch_bullish_threshold: 30
  stoch_bearish_threshold: 70
  stoch_max_bars_since_crossing: 9
  stoch_bar_spec: "15-MINUTE-MID-EXTERNAL"

  # Trade Sizing and Position Management (Fixed)
  trade_size: 100000              # 1 standard lot
  enforce_position_limit: true
  allow_position_reversal: false

# Configuration Summary
# ===================
# Total combinations: 5 × 5 × 4 × 5 = 500
# Parameters being optimized: 4 risk management parameters
# Fixed parameters: 17 parameters at Phase 3 best values
# 
# Phase 3 best results reference (for comparison):
#   - fast_period: 42, slow_period: 270, crossover_threshold_pips: 0.35
#   - sharpe_ratio: 0.272, total_pnl: $5,644.69, win_rate: 48.3%
#   - trade_count: 60, max_drawdown: $0.00
#
# Expected runtime breakdown:
#   - Per backtest: ~60 seconds (7-month period)
#   - Total backtest time: 500 × 60s = 30,000s = 500 minutes = 8.3 hours
#   - Parallelized: 500 min ÷ 8 workers = ~62 minutes pure compute
#   - With overhead: 8-10 hours total
#
# Output files:
#   - phase4_risk_management_results.csv (all 500 results)
#   - phase4_risk_management_results_top_10.json (best 10 parameter sets)
#   - phase4_risk_management_results_summary.json (statistics)
#   - phase4_risk_management_checkpoint.csv (progress)
#
# Success indicators:
#   - Best Sharpe ratio improves on Phase 3 (0.272)
#   - Profit factor > 1.5 (more profit than loss)
#   - Win rate stability (40-50% range)
#   - Max drawdown < $2,000
#   - Top 10 results show clear risk/reward patterns
#
# Next steps:
#   - Review top 10 results for best risk management parameters
#   - Analyze risk/reward ratio patterns
#   - Create Phase 5 filter optimization config with Phase 3 MA + Phase 4 risk parameters fixed
