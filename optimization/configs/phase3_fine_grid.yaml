# ============================================
# Phase 3: Fine Grid Search Configuration - Centered on Phase 2 Best Results
# ============================================
# MA Period and Crossover Threshold Fine Optimization
#
# This configuration refines the optimization by testing 125 combinations (5×5×5) 
# in a narrow range centered on the best parameter set from Phase 2 coarse grid search.
#
# PREREQUISITE: Phase 2 must complete successfully first. This config is generated 
# based on Phase 2 rank 1 results.
#
# Phase 2 Best Results (Rank 1) - VERIFIED:
# - fast_period: 40 (from phase2_coarse_grid_top_10.json)
# - slow_period: 250 (from phase2_coarse_grid_top_10.json)
# - crossover_threshold_pips: 0.5 (from phase2_coarse_grid_top_10.json)
# - sharpe_ratio: 0.344 (verified non-zero value)
# - total_pnl: $6,279.84
# - win_rate: 44.9%
# - trade_count: 49
# - Source: optimization/results/PHASE2_VERIFICATION_REPORT.md
#
# Usage:
#   # Re-export all required environment variables (required for preflight validation)
#   $env:BACKTEST_SYMBOL = "EUR/USD"
#   $env:BACKTEST_VENUE = "IDEALPRO"
#   $env:BACKTEST_START_DATE = "2025-01-01"
#   $env:BACKTEST_END_DATE = "2025-07-31"
#   $env:BACKTEST_BAR_SPEC = "15-MINUTE-MID-EXTERNAL"
#   $env:CATALOG_PATH = "data/historical"
#   $env:OUTPUT_DIR = "logs/backtest_results"
#
#   python optimization/grid_search.py \
#     --config optimization/configs/phase3_fine_grid.yaml \
#     --objective sharpe_ratio \
#     --workers 8 \
#     --output optimization/results/phase3_fine_grid_results.csv \
#     --no-resume \
#     --verbose
#
# Estimated time: 2-3 hours with 8 workers (125 backtests × ~60s each ÷ 8 workers)
#
# Phase Context:
#   This is the second optimization phase. Results will be used to create 
#   Phase 4 risk management configuration.
#
# Success Criteria:
# - Best result improves on Phase 2 Sharpe ratio of 0.344 (target: 0.35-0.40 range)
# - Top 10 results cluster around similar parameter values (stability)
# - No extreme parameter values at boundaries (indicates need for wider search)
# - Minimum acceptable: Sharpe ratio > 0.30 (if fine-tuning doesn't improve)
# - Note: Baseline comparison requires running optimization/validate_baseline.py first

# ============================================
# Optimization Settings
# ============================================
optimization:
  # Objective function to maximize (same as Phase 2)
  # Using Sharpe ratio for risk-adjusted returns optimization
  objective: sharpe_ratio
  
  # Number of parallel workers (same as Phase 2)
  workers: 8
  
  # Save checkpoint every N backtests
  checkpoint_interval: 10
  
  # Maximum time per backtest in seconds
  timeout_seconds: 300
  
  # Output file for results
  output_file: optimization/results/phase3_fine_grid_results.csv
  
  # Checkpoint file for resuming
  checkpoint_file: optimization/checkpoints/phase3_fine_grid_checkpoint.csv

# ============================================
# Parameter Ranges for Fine Grid Search (Centered on Phase 2 Best)
# ============================================
# Testing 3 core parameters with 5 values each centered on Phase 2 rank 1 results
parameters:
  # Fast Moving Average Period
  # Phase 2 best: 40 (Sharpe=0.344)
  # Fine grid range: [36, 38, 40, 42, 44]
  # Rationale: ±10% around Phase 2 best for fine-tuning
  fast_period:
    values: [36, 38, 40, 42, 44]
  
  # Slow Moving Average Period
  # Phase 2 best: 250 (Sharpe=0.344)
  # Fine grid range: [230, 240, 250, 260, 270]
  # Rationale: ±8% around Phase 2 best for fine-tuning
  # Note: Must ensure all values > fast_period (validated by grid_search.py)
  slow_period:
    values: [230, 240, 250, 260, 270]
  
  # Crossover Threshold (pips)
  # Phase 2 best: 0.5 (Sharpe=0.344)
  # Fine grid range: [0.35, 0.425, 0.5, 0.575, 0.65]
  # Rationale: ±30% around Phase 2 best to explore threshold sensitivity
  # Note: Values clamped to [0.0, ∞) to prevent negative thresholds
  crossover_threshold_pips:
    values: [0.35, 0.425, 0.5, 0.575, 0.65]

# ============================================
# Fixed Parameters (Inherited from Phase 2 Best Results)
# ============================================
# These parameters remain constant at Phase 2 best values to isolate MA period and threshold optimization
# Risk management and filter parameters will be optimized in subsequent phases
fixed:
  # ============================================
  # Risk Management Parameters (Fixed at Phase 2 Best)
  # ============================================
  # These will be optimized in Phase 4 after MA parameters are finalized
  
  stop_loss_pips: 25  # From Phase 2 configuration
  take_profit_pips: 50  # From Phase 2 configuration
  trailing_stop_activation_pips: 20  # From Phase 2 configuration
  trailing_stop_distance_pips: 15  # From Phase 2 configuration
  
  # ============================================
  # Crossover Filter Parameters (Fixed at Phase 2 Best)
  # ============================================
  
  pre_crossover_separation_pips: 0.0  # Disabled for Phase 3
  pre_crossover_lookback_bars: 1  # Default value
  
  # ============================================
  # DMI Filter Parameters (Fixed at Phase 2 Best)
  # ============================================
  
  dmi_enabled: true  # Keep enabled to maintain baseline filter behavior
  dmi_period: 14  # Standard 14-period DMI
  dmi_bar_spec: "2-MINUTE-MID-EXTERNAL"  # From Phase 2 configuration
  
  # ============================================
  # Stochastic Filter Parameters (Fixed at Phase 2 Best)
  # ============================================
  
  stoch_enabled: true  # Keep enabled to maintain baseline filter behavior
  stoch_period_k: 14  # Standard 14-period stochastic
  stoch_period_d: 3  # Standard 3-period smoothing
  stoch_bullish_threshold: 30  # From Phase 2 configuration
  stoch_bearish_threshold: 70  # From Phase 2 configuration
  stoch_max_bars_since_crossing: 9  # From Phase 2 configuration
  stoch_bar_spec: "15-MINUTE-MID-EXTERNAL"  # From Phase 2 configuration
  
  # ============================================
  # Trade Sizing and Position Management (Fixed)
  # ============================================
  
  trade_size: 100000  # 1 standard lot for forex
  enforce_position_limit: true  # Prevent multiple positions
  allow_position_reversal: false  # No flipping without closing

# ============================================
# Configuration Summary
# ============================================
#
# Total Combinations: 5 × 5 × 5 = 125
#
# Parameters Being Optimized (Fine Grid):
#   - fast_period: 5 values centered on Phase 2 best (±4 spacing)
#   - slow_period: 5 values centered on Phase 2 best (±20 spacing)
#   - crossover_threshold_pips: 5 values centered on Phase 2 best (±0.3 spacing)
#
# Fixed Parameters: 18 parameters at Phase 2 best values
#
# Phase 2 Best Results (Reference) - VERIFIED:
#   - fast_period: 40
#   - slow_period: 250
#   - crossover_threshold_pips: 0.5
#   - sharpe_ratio: 0.344
#   - total_pnl: $6,279.84
#   - win_rate: 44.9%
#   - trade_count: 49
#   - Source: optimization/results/PHASE2_VERIFICATION_REPORT.md
#
# Expected Runtime:
#   - With 8 workers: ~2-3 hours
#   - Per backtest: ~60 seconds (7-month period)
#   - Total backtest time: 125 × 60s = 7,500s = 125 minutes
#   - Parallelized: 125 min ÷ 8 workers = ~16 minutes
#   - With overhead: ~2-3 hours total
#
# Output Files:
#   - optimization/results/phase3_fine_grid_results.csv (all 125 results)
#   - optimization/results/phase3_fine_grid_results_top_10.json (best 10 parameter sets)
#   - optimization/results/phase3_fine_grid_results_summary.json (statistics)
#   - optimization/checkpoints/phase3_fine_grid_checkpoint.csv (progress)
#
# Success Indicators:
#   ✅ Best Sharpe ratio improves on Phase 2 (or within 5%)
#   ✅ Top 10 results cluster around similar values (parameter stability)
#   ✅ No extreme values at range boundaries (search space is appropriate)
#   ✅ Note: Baseline comparison requires optimization/results/baseline_metrics.json
#
# Next Steps:
#   1. Review top 10 results in phase3_fine_grid_results_top_10.json
#   2. Verify parameter stability (top results should be close in value)
#   3. Create Phase 4 risk management configuration with best MA parameters fixed
#   4. Run Phase 4 to optimize stop loss, take profit, and trailing stops
