# Phase 5: Filter Parameter Optimization (DMI and Stochastic) - MEDIUM VERSION
# ==============================================================================
# 
# This configuration optimizes DMI and Stochastic filter parameters while keeping 
# Phase 3 best MA and Phase 4 best risk management parameters fixed.
# 
# MEDIUM VERSION: 324 combinations (2×3×3×2×3×3) for balanced iteration
# Parameters being optimized: 6 filter parameters (2 DMI + 4 Stochastic)
# Fixed parameters: Phase 3 best MA + Phase 4 best risk management parameters
# Expected runtime: ~6 hours with 8 workers
# 
# Prerequisites: Phase 3 and Phase 4 must complete successfully first
# Phase 3 Best Results (from rank 1):
#   - fast_period: 42
#   - slow_period: 270  
#   - crossover_threshold_pips: 0.35
#   - sharpe_ratio: 0.272
#   - total_pnl: $5,644.69
#   - win_rate: 48.3%
#   - trade_count: 60
#   - Source: optimization/results/phase3_fine_grid_results_top_10.json
#
# Phase 4 Best Results (from rank 1):
#   - stop_loss_pips: 35
#   - take_profit_pips: 50
#   - trailing_stop_activation_pips: 22
#   - trailing_stop_distance_pips: 12
#   - sharpe_ratio: 0.428 (57% improvement over Phase 3)
#   - Source: optimization/results/phase4_risk_management_results_top_10.json
#
# Usage:
#   python optimization/grid_search.py \
#     --config optimization/configs/phase5_filters_medium.yaml \
#     --objective sharpe_ratio \
#     --workers 8 \
#     --output optimization/results/phase5_filters_medium_results.csv \
#     --no-resume \
#     --verbose
#
# Expected runtime: ~6 hours with 8 workers (324 backtests × ~60s each ÷ 8 workers)
# Phase context: Fourth optimization phase, results will be used for Phase 6 parameter refinement
#
# Success criteria:
#   - Best result maintains or improves Phase 4 Sharpe ratio of 0.428
#   - Analyze filter impact on win rate (target: maintain 40-50% range)
#   - Analyze filter impact on trade count (understand trade-off between quality and quantity)
#   - Top 10 results show clear filter parameter patterns
#   - Identify whether filters improve or degrade performance

# Optimization Settings
# ====================
optimization:
  objective: sharpe_ratio  # Maximize risk-adjusted returns
  workers: 8               # Parallel execution
  checkpoint_interval: 10   # Save progress every 10 backtests
  timeout_seconds: 300     # 5 minutes per backtest
  output_file: optimization/results/phase5_filters_medium_results.csv
  checkpoint_file: optimization/checkpoints/phase5_filters_medium_checkpoint.csv

# Parameters Being Optimized (MEDIUM RANGES)
# ==========================================
# Filter Parameters - 6 parameters, 324 total combinations
parameters:
  # DMI Filter Parameters
  
  # DMI Enabled: Test whether DMI filter improves or degrades performance
  # If false, dmi_period is ignored. This tests the hypothesis that DMI filtering adds value.
  dmi_enabled:
    values:
      - true   # Keep DMI filter enabled (current baseline)
      - false  # Disable DMI filter to test if it adds value

  # DMI Period: Test fast, baseline, and slow periods
  # Focus on the most promising range around the baseline
  dmi_period:
    values:
      - 10  # Fast DMI - very responsive to trend changes
      - 14  # Standard DMI period (current baseline)
      - 18  # Slow DMI - very smooth trend detection

  # Stochastic Filter Parameters
  
  # Stochastic %K Period: Test fast, baseline, and slow periods
  # Focus on the most promising range around the baseline
  stoch_period_k:
    values:
      - 10  # Fast Stochastic - very sensitive to price changes
      - 14  # Standard Stochastic period (current baseline)
      - 18  # Slow Stochastic - very smooth price sensitivity

  # Stochastic %D Period: Test minimal vs moderate smoothing
  # Higher smoothing reduces noise but increases lag
  stoch_period_d:
    values:
      - 3  # Minimal smoothing - very responsive
      - 5  # Moderate smoothing - balanced responsiveness

  # Stochastic Bullish Threshold: Test aggressive, baseline, and conservative
  # Focus on the most impactful threshold range
  stoch_bullish_threshold:
    values:
      - 20  # Aggressive threshold - more long signals
      - 30  # Standard threshold (current baseline)
      - 35  # Conservative threshold - fewer but higher quality signals

  # Stochastic Bearish Threshold: Test baseline vs aggressive
  # Focus on the most impactful threshold range
  stoch_bearish_threshold:
    values:
      - 70  # Standard threshold (current baseline)
      - 75  # Moderate aggressive threshold
      - 80  # Aggressive threshold - fewer but higher quality signals

# Fixed Parameters (Phase 3 and Phase 4 Best Values)
# ===================================================
# All parameters below are fixed at Phase 3 and Phase 4 best values and will not be optimized
fixed:
  # MA Parameters (Fixed at Phase 3 Best - DO NOT CHANGE)
  # These are the optimal MA parameters from Phase 3 and must not be changed
  fast_period: 42                    # Phase 3 rank 1 value
  slow_period: 270                   # Phase 3 rank 1 value  
  crossover_threshold_pips: 0.35      # Phase 3 rank 1 value

  # Risk Management Parameters (Fixed at Phase 4 Best - DO NOT CHANGE)
  # These are the optimal risk management parameters from Phase 4 and must not be changed
  stop_loss_pips: 35                 # Phase 4 rank 1 value
  take_profit_pips: 50               # Phase 4 rank 1 value
  trailing_stop_activation_pips: 22   # Phase 4 rank 1 value
  trailing_stop_distance_pips: 12      # Phase 4 rank 1 value

  # Crossover Filter Parameters (Fixed)
  pre_crossover_separation_pips: 0.0    # Disabled
  pre_crossover_lookback_bars: 1        # Default

  # DMI Bar Specification (Fixed)
  dmi_bar_spec: "2-MINUTE-MID-EXTERNAL"  # Keep consistent with Phase 3/4

  # Stochastic Additional Parameters (Fixed)
  stoch_max_bars_since_crossing: 9      # Keep at Phase 3/4 value
  stoch_bar_spec: "15-MINUTE-MID-EXTERNAL"  # Keep consistent with Phase 3/4

  # Trade Sizing and Position Management (Fixed)
  trade_size: 100000              # 1 standard lot
  enforce_position_limit: true
  allow_position_reversal: false

# Configuration Summary
# ===================
# Total combinations: 2 × 3 × 3 × 2 × 3 × 3 = 324
# Parameters being optimized: 6 filter parameters (2 DMI + 4 Stochastic)
# Fixed parameters: 11 parameters at Phase 3 and Phase 4 best values
# 
# Phase 3 and Phase 4 best results reference (for comparison):
#   - Phase 3: fast=42, slow=270, threshold=0.35, sharpe=0.272
#   - Phase 4: stop_loss=35, take_profit=50, trailing_activation=22, trailing_distance=12, sharpe=0.428
#
# Expected runtime breakdown:
#   - Per backtest: ~60 seconds (7-month period)
#   - Total backtest time: 324 × 60s = 19,440s = 324 minutes = 5.4 hours
#   - Parallelized: 324 min ÷ 8 workers = 40.5 minutes pure compute
#   - With overhead: ~6 hours total
#
# Output files:
#   - phase5_filters_medium_results.csv (all 324 results)
#   - phase5_filters_medium_results_top_10.json (best 10 parameter sets)
#   - phase5_filters_medium_results_summary.json (statistics)
#   - phase5_filters_medium_checkpoint.csv (progress)
#
# Success indicators:
#   - Best Sharpe ratio maintains or improves on Phase 4 (0.428)
#   - Clear understanding of filter impact on win rate and trade count
#   - Identification of optimal filter configurations
#   - Top 10 results show parameter clustering (stability)
#
# Purpose: Balanced iteration between reduced (108) and full (2,400) versions
# Recommendation: Use this for thorough but manageable optimization
# Note: This provides good coverage while remaining computationally feasible
#
# Next steps:
#   - Review top 10 results for best filter parameters
#   - Analyze filter impact on win rate and trade count
#   - If results are promising, consider full version (2,400 combinations, ~40 hours)
#   - Create Phase 6 parameter refinement config with Phase 3 MA + Phase 4 risk + Phase 5 filter parameters
