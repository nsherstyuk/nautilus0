# TP/SL Optimization with Fixed Excluded Hours
# =============================================
# 
# Focused optimization on risk management parameters (TP, SL, trailing stops)
# while keeping excluded hours fixed based on hourly profitability analysis.
# 
# Total combinations: 5 × 5 × 5 × 5 = 625 combinations
# Expected runtime: 10-12 hours with 8 workers, ~5-6 hours with 15 workers
# 
# Prerequisites:
#   1. Run hourly profitability analysis: python scripts/verify_excluded_hours.py
#   2. Update BACKTEST_EXCLUDED_HOURS in .env with correct hours
#   3. Verify excluded hours are working correctly
#
# Usage:
#   python optimization/grid_search.py \
#     --config optimization/configs/tp_sl_optimization.yaml \
#     --objective sharpe_ratio \
#     --workers 8 \
#     --output optimization/results/tp_sl_results.csv \
#     --no-resume \
#     --verbose

# Optimization Settings
optimization:
  objective: sharpe_ratio  # Maximize risk-adjusted returns
  workers: 15              # Parallel execution (use CPU cores - 1, or override with --workers)
  checkpoint_interval: 10   # Save progress every 10 backtests
  timeout_seconds: 300     # 5 minutes per backtest
  output_file: optimization/results/tp_sl_optimization_results.csv
  checkpoint_file: optimization/checkpoints/tp_sl_optimization_checkpoint.csv

# Parameters Being Optimized
# ==========================
# Risk Management Parameters Only - 4 parameters, 625 total combinations
parameters:
  # Stop Loss Pips: Test range from tight (15 pips) to loose (35 pips) stops
  stop_loss_pips:
    values:
      - 15  # Tight stop - quick exits, higher trade count
      - 20  # Moderate tight stop
      - 25  # Baseline stop
      - 30  # Moderate loose stop
      - 35  # Loose stop - more breathing room, higher risk per trade

  # Take Profit Pips: Test range from conservative (30 pips) to aggressive (75 pips)
  take_profit_pips:
    values:
      - 30  # Conservative target (2:1 RR with 15 pip SL)
      - 40  # Moderate conservative target
      - 50  # Baseline target
      - 60  # Moderate aggressive target
      - 75  # Aggressive target (2.5:1 RR with 30 pip SL)

  # Trailing Stop Activation: Test when trailing stop activates
  trailing_stop_activation_pips:
    values:
      - 10  # Very early activation - protect profits quickly
      - 15  # Early activation
      - 20  # Moderate early activation
      - 25  # Late activation
      - 30  # Very late activation - allow more profit potential

  # Trailing Stop Distance: Test how closely trailing stop follows price
  trailing_stop_distance_pips:
    values:
      - 8   # Very tight trailing - lock in profits very quickly
      - 10  # Tight trailing
      - 12  # Moderate tight trailing
      - 15  # Moderate loose trailing
      - 18  # Loose trailing - allow more retracement

# Fixed Parameters
# ================
# IMPORTANT: These should match your current best parameters from previous phases
# and include correct excluded hours from hourly profitability analysis
fixed:
  # MA Parameters (Fixed at best values from previous optimization)
  fast_period: 42
  slow_period: 270
  crossover_threshold_pips: 0.35

  # Filter Parameters (Fixed at best values from previous optimization)
  dmi_enabled: true
  dmi_period: 14
  dmi_minimum_difference: 0.0
  dmi_bar_spec: "2-MINUTE-MID-EXTERNAL"
  
  stoch_enabled: true
  stoch_period_k: 14
  stoch_period_d: 3
  stoch_bullish_threshold: 30
  stoch_bearish_threshold: 70
  stoch_max_bars_since_crossing: 9
  stoch_bar_spec: "15-MINUTE-MID-EXTERNAL"

  # Time Filter (FIXED based on hourly profitability analysis)
  # IMPORTANT: Set these based on verify_excluded_hours.py output
  # Example (currently recommended): "0,4,5,6,8,12,15,18,19,20,22"
  # NOTE: excluded_hours must be set in .env file BEFORE running optimization
  # The grid search will use BACKTEST_EXCLUDED_HOURS from environment
  
  # Primary bar specification
  bar_spec: "1-MINUTE-MID-EXTERNAL"
  
  # Trade Sizing and Position Management
  trade_size: 100000
  enforce_position_limit: true
  allow_position_reversal: false
  starting_capital: 100000.0
  
  # Multi-timeframe parameters (disabled)
  trend_filter_enabled: false
  entry_timing_enabled: false
  
  # Crossover filter parameters
  pre_crossover_separation_pips: 0.0
  pre_crossover_lookback_bars: 1

# Configuration Summary
# ===================
# Total combinations: 5 × 5 × 5 × 5 = 625
# Parameters being optimized: 4 risk management parameters
# Fixed parameters: MA parameters + filters + excluded hours
# 
# Expected runtime breakdown:
#   - Per backtest: ~60 seconds (7-month period)
#   - Total backtest time: 625 × 60s = 37,500s = 625 minutes = 10.4 hours
#   - Parallelized with 8 workers: 625 min ÷ 8 = ~78 minutes pure compute
#   - Parallelized with 15 workers: 625 min ÷ 15 = ~42 minutes pure compute
#   - With overhead: 10-12 hours (8 workers) or 5-6 hours (15 workers)
#
# Success criteria:
#   - Best result improves on current baseline Sharpe ratio
#   - Profit factor > 1.5
#   - Win rate stability (40-50% range)
#   - Max drawdown < $2,000
#   - Top 10 results show clear risk/reward patterns
#
# Output files:
#   - tp_sl_optimization_results.csv (all 625 results)
#   - tp_sl_optimization_results_top_10.json (best 10 parameter sets)
#   - tp_sl_optimization_results_summary.json (statistics)

