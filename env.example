# NautilusTrader Environment Variables Example
# Copy this file to .env and modify the values as needed

# =============================================================================
# BACKTESTING PARAMETERS
# =============================================================================

# Required Variables
BACKTEST_SYMBOL=EUR-USD
BACKTEST_START_DATE=2024-01-01
BACKTEST_END_DATE=2024-12-31

# Optional Variables with Defaults
BACKTEST_VENUE=IDEALPRO
BACKTEST_BAR_SPEC=1-MINUTE-MID-EXTERNAL  # Default: 1-minute bars for MA crossover strategy
BACKTEST_FAST_PERIOD=10
BACKTEST_SLOW_PERIOD=20
BACKTEST_TRADE_SIZE=100
BACKTEST_STARTING_CAPITAL=100000.0
CATALOG_PATH=data/historical
OUTPUT_DIR=logs/backtest_results
ENFORCE_POSITION_LIMIT=true
ALLOW_POSITION_REVERSAL=false

#
# Multi-Timeframe Bar Ingestion for Forex:
# When ingesting forex data, the script automatically downloads multiple timeframes:
#   - 1-minute bars:  Primary timeframe for MA crossover signals (default)
#   - 2-minute bars:  Used by DMI trend filter (see STRATEGY_DMI_BAR_SPEC)
#   - 15-minute bars: Used by Stochastic momentum filter (see STRATEGY_STOCH_BAR_SPEC)
#   - Daily bars:     Used for longer-term analysis and context
#
# All timeframes are downloaded in a single ingestion run. No additional configuration
# is needed - the script handles chunking automatically based on IBKR limits.
#
# Expected download time for 30 days of EUR/USD data:
#   - 1-minute:  ~43,200 bars (5 chunks × 7 days, ~50 seconds)
#   - 2-minute:  ~21,600 bars (1 chunk × 30 days, ~10 seconds)
#   - 15-minute: ~2,880 bars (1 chunk × 30 days, ~5 seconds)
#   - Daily:     ~30 bars (1 chunk, <1 second)
#   Total: ~65 seconds + pacing delays (~40 seconds) = ~105 seconds (~2 minutes)
#
# Storage requirements per 30 days:
#   - 1-minute:  ~15-20 MB
#   - 2-minute:  ~8-10 MB
#   - 15-minute: ~1-2 MB
#   - Daily:     <1 MB
#   Total: ~25-35 MB per symbol per month

# Stop Loss and Take Profit Configuration
BACKTEST_STOP_LOSS_PIPS=25
BACKTEST_TAKE_PROFIT_PIPS=50

# Trailing Stop Configuration
# Trailing stop activates when position profit reaches activation threshold,
# then dynamically moves stop loss to lock in profits as price moves favorably.
# Example: With activation=20 and distance=15:
#   - Position opens at 1.1000
#   - Price moves to 1.1020 (+20 pips) → trailing activates
#   - Stop loss moves to 1.1005 (current price - 15 pips)
#   - Price moves to 1.1030 → stop moves to 1.1015
#   - Stop only moves in favorable direction (never widens)
BACKTEST_TRAILING_STOP_ACTIVATION_PIPS=20   # Activate trailing after this many pips in profit
BACKTEST_TRAILING_STOP_DISTANCE_PIPS=15     # Trail stop loss by this many pips behind current price

# ============================================================================
# STRATEGY FILTERS & ENHANCEMENTS
# ============================================================================
# Advanced filters to improve signal quality and reduce false signals
# All filters are optional and disabled by default for backward compatibility

# MA Crossover Threshold - Minimum distance between fast and slow MA for signal confirmation
BACKTEST_CROSSOVER_THRESHOLD_PIPS=0.7
# For EUR/USD: 0.7 pips = 0.00007 price difference
# Higher values reduce false signals but may miss valid crossovers

# Limit Order Configuration - Use limit orders at next bar open instead of market orders
BACKTEST_USE_LIMIT_ORDERS=true
# true = LIMIT order at next bar open (better price control, may not fill)
# false = MARKET order at current bar close (immediate execution, slippage risk)
BACKTEST_LIMIT_ORDER_TIMEOUT_BARS=1
# Cancel unfilled limit orders after N bars (default: 1 bar = 1 minute on 1-min timeframe)

# DMI (Directional Movement Index) Trend Filter - Validates trend direction alignment
BACKTEST_DMI_ENABLED=true
BACKTEST_DMI_PERIOD=14
# Standard DMI period is 14 (Wilder's original specification)
BACKTEST_DMI_BAR_SPEC=2-MINUTE-MID-EXTERNAL
# DMI calculated on 2-minute bars for smoother trend detection
# For BUY: requires +DI > -DI (uptrend), For SELL: requires -DI > +DI (downtrend)

# Stochastic Momentum Filter - Validates momentum alignment and crossing recency
BACKTEST_STOCH_ENABLED=true
BACKTEST_STOCH_PERIOD=14
# %K period (fast stochastic line)
BACKTEST_STOCH_SMOOTH_PERIOD=3
# %D period (slow stochastic line, smoothing of %K)
BACKTEST_STOCH_BAR_SPEC=15-MINUTE-MID-EXTERNAL
# Stochastic calculated on 15-minute bars (can also use 2-MINUTE-MID-EXTERNAL)
BACKTEST_STOCH_BULLISH_THRESHOLD=30
# For BUY signals: %K must be above this threshold (oversold exit)
BACKTEST_STOCH_BEARISH_THRESHOLD=70
# For SELL signals: %K must be below this threshold (overbought exit)
BACKTEST_STOCH_MAX_BARS_SINCE_CROSSING=9
# Maximum 1-minute bars since %K/%D crossing (ensures fresh momentum signal)
# For BUY: requires bullish crossing (%K crossed above %D) within last 9 bars
# For SELL: requires bearish crossing (%K crossed below %D) within last 9 bars

# ATR (Average True Range) Volatility Filter - Rejects trades in choppy or extreme volatility
BACKTEST_ATR_ENABLED=false
# Disabled by default - enable to filter based on market volatility
BACKTEST_ATR_PERIOD=14
# Standard ATR period is 14
BACKTEST_ATR_MIN_THRESHOLD=0.0003
# Reject trades if ATR < this (choppy/low volatility). For EUR/USD: 0.0003 = 3 pips
BACKTEST_ATR_MAX_THRESHOLD=0.003
# Reject trades if ATR > this (extreme volatility). For EUR/USD: 0.003 = 30 pips
# Adjust thresholds based on instrument characteristics and market conditions

# ADX (Average Directional Index) Trend Strength Filter - Rejects trades in weak trends
BACKTEST_ADX_ENABLED=false
# Disabled by default - enable to filter based on trend strength
BACKTEST_ADX_PERIOD=14
# ADX period (should match DMI period for consistency)
BACKTEST_ADX_MIN_THRESHOLD=20.0
# Reject trades if ADX < this. Standard: <20=weak trend, 20-25=emerging, >25=strong
# Uses DMI indicator (same 2-minute bars), no separate subscription needed

# Time-of-Day Filter - Restricts trading to specific hours (avoids low liquidity periods)
BACKTEST_TIME_FILTER_ENABLED=false
# Disabled by default - enable to restrict trading hours
BACKTEST_TRADING_HOURS_START=8
# Trading window start hour (0-23) in market timezone
BACKTEST_TRADING_HOURS_END=16
# Trading window end hour (0-23) in market timezone
BACKTEST_MARKET_TIMEZONE=America/New_York
# IANA timezone string (America/New_York, Europe/London, Asia/Tokyo, UTC)
BACKTEST_EXCLUDED_HOURS=
# Comma-separated hours to exclude within trading window (e.g., 12,13 for lunch break)
# For overnight windows: set start > end (e.g., start=22, end=6 for 10pm-6am)

# Circuit Breaker - Pauses trading after consecutive losses to prevent drawdown spirals
BACKTEST_CIRCUIT_BREAKER_ENABLED=false
# Disabled by default - enable to add risk management protection
BACKTEST_MAX_CONSECUTIVE_LOSSES=3
# Trigger circuit breaker after this many consecutive losing trades
BACKTEST_COOLDOWN_BARS=10
# Pause trading for this many bars after circuit breaker triggers
# Example: 3 losses triggers 10-bar cooldown (10 minutes on 1-min bars)
# Resets to 0 on winning trade; cooldown expires after N bars

# Filter Ordering: Circuit Breaker → Threshold → ATR → Time → ADX → DMI → Stochastic
# Filters are checked in sequence; first rejection stops evaluation (efficient)

# =============================================================================
# LIVE TRADING PARAMETERS
# =============================================================================

# Interactive Brokers Configuration
IBKR_HOST=127.0.0.1
IBKR_PORT=7497
IBKR_CLIENT_ID=1

# =============================================================================
# FOREX EXAMPLE CONFIGURATION
# =============================================================================

# Example for EUR/USD trading
# BACKTEST_SYMBOL=EUR-USD
# BACKTEST_VENUE=IDEALPRO
# BACKTEST_BAR_SPEC=1-MINUTE-MID-EXTERNAL
# BACKTEST_STOP_LOSS_PIPS=25     # Stop loss distance in pips (EUR/USD: 25 pips = 0.0025)
# BACKTEST_TAKE_PROFIT_PIPS=50   # Take profit distance in pips (EUR/USD: 50 pips = 0.0050)
# BACKTEST_TRAILING_STOP_ACTIVATION_PIPS=20  # Activate trailing stop after this many pips of profit
# BACKTEST_TRAILING_STOP_DISTANCE_PIPS=15    # Trail stop loss by this many pips behind current price

# =============================================================================
# IBKR HISTORICAL DATA CHUNKING CONFIGURATION
# =============================================================================
# Automatic chunking prevents timeouts when requesting large date ranges.
# IBKR has documented limits (60 requests per 10 minutes) and practical
# timeout thresholds that vary by bar size:
#   - 1-minute bars: ~7 days per request
#   - 15-minute bars: ~60 days per request
#   - Daily bars: ~10 years per request
#
# Chunking splits large date ranges into smaller requests with pacing delays.

# Enable/disable automatic chunking (default: true)
# Set to false to use single requests (only for short date ranges)
IBKR_ENABLE_CHUNKING=true

# Delay between chunk requests in seconds (default: 10)
# Prevents IBKR pacing violations (max 60 requests per 10 minutes)
# Recommended: 10 seconds (safe for all bar sizes)
# Minimum: 1 second (risky, may trigger error 162)
IBKR_REQUEST_DELAY_SECONDS=10

# Overlap between chunks in minutes (default: 0)
# Adds redundancy at chunk boundaries to prevent gaps
# Set to 0 for no overlap (recommended for most use cases)
# Set to 1-5 minutes if you observe missing bars at chunk boundaries
IBKR_CHUNK_OVERLAP_MINUTES=0

# Example: Requesting 30 days of 1-minute bars
# - Without chunking: Single request, likely timeout
# - With chunking: 5 chunks (7+7+7+7+2 days), 10s delay between chunks
# - Total time: ~50 seconds (5 chunks × 10s delay)

# =============================================================================
# STOCK EXAMPLE CONFIGURATION
# =============================================================================

# Example for stock trading (SL/TP pips not applicable)
# BACKTEST_SYMBOL=AAPL
# BACKTEST_VENUE=SMART
# BACKTEST_BAR_SPEC=1-MINUTE-LAST-EXTERNAL
# Note: For stocks, use percentage-based or tick-based stops instead of pips

# =============================================================================
# CRYPTO EXAMPLE CONFIGURATION
# =============================================================================

# Example for crypto trading (SL/TP pips not applicable)
# BACKTEST_SYMBOL=BTC-USD
# BACKTEST_VENUE=COINBASE
# BACKTEST_BAR_SPEC=1-MINUTE-LAST-EXTERNAL
# Note: For crypto, use percentage-based or tick-based stops instead of pips
